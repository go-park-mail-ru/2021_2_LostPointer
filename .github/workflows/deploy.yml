name: deploy

on:
  push:
    branches:
      - dev
      - los-98
  pull_request:
    branches:
      - dev
      - main

jobs:
  #  tests:
  #    name: Run tests
  #    runs-on: ubuntu-latest
  #    steps:
  #      - name: Install Go
  #        uses: actions/setup-go@v2
  #        with:
  #          go-version: '1.16.x'
  #      - name: Checkout code
  #        uses: actions/checkout@v2
  #      - name: Run all tests
  #        run: make tests
  #  linter:
  #    name: Run linter
  #    runs-on: ubuntu-latest
  #    steps:
  #      - name: Install Go
  #        uses: actions/setup-go@v2
  #        with:
  #          go-version: '1.16.x'
  #      - name: Checkout code
  #        uses: actions/checkout@v2
  #      - name: Run linter
  #        run: |
  #          export PATH=$PATH:$(go env GOPATH)/bin
  #          go get github.com/golangci/golangci-lint/cmd/golangci-lint
  #          make lint
    build:
      name: Build Docker
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v2
          with:
            ref: los-98
        - name: Install Docker Buildx
          uses: docker/setup-buildx-action@v1
        - name: Login to Docker
          uses: docker/login-action@v1
          with:
            username: "vershovbmstu"
            password: "Avt8430055"
        - name: Push to Docker Hub
          env:
            DBUSER: postgres
            DBPASS: root
            DBNAME: lostpointer
            PG_EXTERNAL_PORT: 54321
            REDIS_EXTERNAL_PORT: 63799
          run: |
            docker-compose build
            docker tag 2021_2_lostpointer_main vershovbmstu/lostpointer_deploy_main:latest
            docker push vershovbmstu/lostpointer_deploy_main:latest
            docker tag 2021_2_lostpointer_authorization vershovbmstu/lostpointer_deploy_authorization:latest
            docker push vershovbmstu/lostpointer_deploy_authorization:latest
            docker tag 2021_2_lostpointer_music vershovbmstu/lostpointer_deploy_music:latest
            docker push vershovbmstu/lostpointer_deploy_music:latest
            docker tag 2021_2_lostpointer_profile vershovbmstu/lostpointer_deploy_profile:latest
            docker push vershovbmstu/lostpointer_deploy_profile:latest
            docker tag 2021_2_lostpointer_playlists vershovbmstu/lostpointer_deploy_playlists:latest
            docker push vershovbmstu/lostpointer_deploy_playlists:latest
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: los-98
      - name: Send docker-compose via ssh
        uses: appleboy/scp-action@master
        with:
          host: "lostpointer.site"
          username: "ubuntu"
          key: "-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9VgAAAJjhHDWY4Rw1
mAAAAAtzc2gtZWQyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9Vg
AAAEDtGbVSF49F0UdxUvlSZclzMOK3B3KI2BRENiWoeBulA2oHKjQv5uS5kQwksiq8H77k
InRa5g2TsDS0PVxIZb1WAAAAE3Rlc3RATWFjQm9vay1Qcm8tMTYBAg==
-----END OPENSSH PRIVATE KEY-----
"
          source: "docker-compose-cd.yml"
          target: "/home/ubuntu/back_cd"
      - name: Send .env via ssh
        uses: appleboy/scp-action@master
        with:
          host: "lostpointer.site"
          username: "ubuntu"
          key: "-----BEGIN OPENSSH PRIVATE KEY-----
    b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
    QyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9VgAAAJjhHDWY4Rw1
    mAAAAAtzc2gtZWQyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9Vg
    AAAEDtGbVSF49F0UdxUvlSZclzMOK3B3KI2BRENiWoeBulA2oHKjQv5uS5kQwksiq8H77k
    InRa5g2TsDS0PVxIZb1WAAAAE3Rlc3RATWFjQm9vay1Qcm8tMTYBAg==
    -----END OPENSSH PRIVATE KEY-----
    "
          source: ".env-prod"
          target: "/home/ubuntu/back_cd"
      - name: Pull docker images
        uses: appleboy/ssh-action@master
        with:
          host: "lostpointer.site"
          username: "ubuntu"
          key: "-----BEGIN OPENSSH PRIVATE KEY-----
         b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
         QyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9VgAAAJjhHDWY4Rw1
         mAAAAAtzc2gtZWQyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9Vg
         AAAEDtGbVSF49F0UdxUvlSZclzMOK3B3KI2BRENiWoeBulA2oHKjQv5uS5kQwksiq8H77k
         InRa5g2TsDS0PVxIZb1WAAAAE3Rlc3RATWFjQm9vay1Qcm8tMTYBAg==
         -----END OPENSSH PRIVATE KEY-----
         "
          script: |
            sudo docker pull vershovbmstu/lostpointer_deploy_authorization:latest
            sudo docker pull vershovbmstu/lostpointer_deploy_main:latest
            sudo docker pull vershovbmstu/lostpointer_deploy_music:latest
            sudo docker pull vershovbmstu/lostpointer_deploy_playlists:latest
            sudo docker pull vershovbmstu/lostpointer_deploy_profile:latest
      - name: Run docker-compose
        uses: appleboy/ssh-action@master
        with:
          host: "lostpointer.site"
          username: "ubuntu"
          key: "-----BEGIN OPENSSH PRIVATE KEY-----
                 b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
                 QyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9VgAAAJjhHDWY4Rw1
                 mAAAAAtzc2gtZWQyNTUxOQAAACBqByo0L+bkuZEMJLIqvB++5CJ0WuYNk7A0tD1cSGW9Vg
                 AAAEDtGbVSF49F0UdxUvlSZclzMOK3B3KI2BRENiWoeBulA2oHKjQv5uS5kQwksiq8H77k
                 InRa5g2TsDS0PVxIZb1WAAAAE3Rlc3RATWFjQm9vay1Qcm8tMTYBAg==
                 -----END OPENSSH PRIVATE KEY-----
                 "
          script: |
            cd back_cd
            sudo docker rm -f $(sudo docker ps -aq)
            sudo docker-compose -f docker-compose-cd.yml up --build -d




